<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos: 英国历史探索 - 龚凤乾教授设计</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;700&family=Inter:wght@400;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .serif { font-family: 'Crimson Pro', serif; }
        .bilingual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        @media (max-width: 768px) { .bilingual-grid { grid-template-columns: 1fr; } }
        .play-btn { transition: all 0.2s; cursor: pointer; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.1); }
        .play-btn.playing { background: #22c55e; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .chat-scroll { max-height: 400px; overflow-y: auto; scrollbar-width: thin; }
        .history-item:hover .delete-btn { opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ERAS = [
            { id: 'pre-roman', name: '史前与凯尔特', enName: 'Pre-Roman & Celtic', year: 'Before AD 43', quickIntro: { zh: "史前时期的英国是不列颠文明的曙光，以巨石阵和凯尔特部落文明闻名。", en: "Pre-Roman Britain marks the dawn of civilization, famous for Stonehenge and Celtic tribes." }, detailedContent: { zh: "不列颠群岛的史前时期始于旧石器时代晚期，持续到公元43年罗马入侵...", en: "The prehistoric period of the British Isles began in the late Paleolithic era..." }, sources: [{ name: "British Museum", url: "https://www.britishmuseum.org" }] },
            { id: 'roman', name: '罗马统治时期', enName: 'Roman Britain', year: 'AD 43 - 410', quickIntro: { zh: "罗马人带来了城市、道路和法律。哈德良长城是这一时期的重要遗迹。", en: "Romans introduced cities, roads, and laws. Hadrian's Wall remains a key landmark." }, detailedContent: { zh: "公元43年，罗马皇帝克劳狄乌斯派遣四万大军入侵不列颠...", en: "In AD 43, Emperor Claudius sent 40,000 troops to invade Britain..." }, sources: [{ name: "Roman Britain Org", url: "https://www.roman-britain.co.uk" }] },
            { id: 'anglo-saxon', name: '盎格鲁-撒克逊', enName: 'Anglo-Saxon Era', year: '410 - 1066', quickIntro: { zh: "罗马撤军后，日耳曼部落定居于此，形成了早期英格兰王国的雏形。", en: "After Romans left, Germanic tribes settled, forming the early kingdoms of England." }, detailedContent: { zh: "罗马军队撤离后，来自日德兰半岛和德国北部的盎格鲁-撒克逊人入侵并定居不列颠...", en: "After Roman withdrawal, Angles, Saxons, and Jutes from Jutland..." }, sources: [{ name: "British Library", url: "https://www.bl.uk/anglo-saxons" }] },
            { id: 'medieval', name: '中世纪盛期', enName: 'The Middle Ages', year: '1066 - 1485', quickIntro: { zh: "从诺曼征服到玫瑰战争，这是一个骑士、领主和大宪章的时代。", en: "From the Norman Conquest to the Wars of the Roses, an age of knights and Magna Carta." }, detailedContent: { zh: "诺曼征服后，威廉一世建立了封建制度...", en: "After the Norman Conquest, William I established feudalism..." }, sources: [{ name: "National Archives", url: "https://www.nationalarchives.gov.uk" }] },
            { id: 'tudor', name: '都铎王朝', enName: 'The Tudors', year: '1485 - 1603', quickIntro: { zh: "亨利八世与伊丽莎白一世的黄金时代，见证了宗教改革和海外扩张。", en: "The golden age of Henry VIII and Elizabeth I, seeing the Reformation and expansion." }, detailedContent: { zh: "都铎王朝始于亨利·都铎（亨利七世）在博斯沃思战役中获胜...", en: "The Tudor dynasty began with Henry Tudor's (Henry VII) victory..." }, sources: [{ name: "Royal Palaces", url: "https://www.hrp.org.uk" }] },
            { id: 'stuart', name: '斯图亚特王朝', enName: 'Stuart Period', year: '1603 - 1714', quickIntro: { zh: "经历了内战与光荣革命，英国最终确立了君主立宪政体。", en: "Through Civil War and the Glorious Revolution, Britain became a constitutional monarchy." }, detailedContent: { zh: "斯图亚特王朝始于苏格兰的詹姆斯六世成为英格兰的詹姆斯一世...", en: "The Stuart period began with Scotland's James VI becoming England's James I..." }, sources: [{ name: "Civil War Project", url: "https://www.english-heritage.org.uk" }] },
            { id: 'georgian', name: '乔治时代', enName: 'Georgian Era', year: '1714 - 1837', quickIntro: { zh: "大英帝国扩张的时期，也见证了工业革命的萌芽。", en: "An era of imperial expansion and the dawn of the Industrial Revolution." }, detailedContent: { zh: "以四位乔治国王命名，这一时代见证了英国成为全球主导力量...", en: "Named for four King Georges, this era saw Britain become a global power..." }, sources: [{ name: "Georgian Papers", url: "https://georgianpapers.com" }] },
            { id: 'victorian', name: '维多利亚时代', enName: 'Victorian Era', year: '1837 - 1901', quickIntro: { zh: "英国工业鼎盛时期，被称为'日不落帝国'，社会发生剧烈变革。", en: "The peak of industrial power and the height of the British Empire." }, detailedContent: { zh: "维多利亚时代以维多利亚女王命名，是大英帝国的鼎盛时期...", en: "The Victorian era, named after Queen Victoria (reigned 1837-1901)..." }, sources: [{ name: "V&A Museum", url: "https://www.vam.ac.uk" }] },
            { id: 'edwardian', name: '爱德华时代', enName: 'Edwardian Era', year: '1901 - 1910', quickIntro: { zh: "一战前的短暂繁荣与宁静，优雅与社会动荡并存。", en: "A brief period of elegance and social unrest before the First World War." }, detailedContent: { zh: "爱德华七世的统治是一战前最后的和平时期...", en: "Edward VII's reign was the last peaceful period before WWI..." }, sources: [{ name: "Edwardian Culture", url: "http://www.edwardianculture.com" }] },
            { id: 'world-wars', name: '世界大战时期', enName: 'World Wars Era', year: '1914 - 1945', quickIntro: { zh: "两次大战深刻改变了英国的地位，也是全民英勇抗战的岁月。", en: "Two World Wars reshaped Britain's global standing and social fabric." }, detailedContent: { zh: "第一次世界大战造成90万英国士兵死亡，社会结构被改变...", en: "World War I (1914-1918) caused 900,000 British military deaths..." }, sources: [{ name: "IWM", url: "https://www.iwm.org.uk" }] },
            { id: 'post-war', name: '战后重建', enName: 'Post-War Period', year: '1945 - 1979', quickIntro: { zh: "福利国家的建立和帝国的去殖民化是这一时期的主题。", en: "The birth of the welfare state and the decolonization of the Empire." }, detailedContent: { zh: "战后工党政府建立了国民医疗服务体系（NHS）...", en: "Postwar Labour government established the National Health Service (NHS)..." }, sources: [{ name: "Parliament UK", url: "https://www.parliament.uk" }] },
            { id: 'thatcher', name: '撒切尔时代', enName: 'Thatcher Era', year: '1979 - 1990', quickIntro: { zh: "撒切尔夫人的经济改革深刻地改变了英国的社会结构。", en: "Margaret Thatcher's reforms radically transformed the British economy." }, detailedContent: { zh: "玛格丽特·撒切尔推行新自由主义改革：国有企业私有化...", en: "Margaret Thatcher implemented neoliberal reforms..." }, sources: [{ name: "Thatcher Foundation", url: "https://www.margaretthatcher.org" }] },
            { id: 'modern', name: '现代英国', enName: 'Modern Britain', year: '1990 - Present', quickIntro: { zh: "在数字化与全球化背景下，英国在传统与变革中寻找新角色。", en: "Navigating globalization while seeking a new national identity." }, detailedContent: { zh: "现代英国经历了冷战结束、欧盟一体化及脱欧公投等...", en: "Modern Britain witnessed the Cold War's end, EU integration..." }, sources: [{ name: "GOV.UK", url: "https://www.gov.uk" }] }
        ];

        const App = () => {
            const [currentEra, setCurrentEra] = useState(ERAS[0]);
            const [content, setContent] = useState(ERAS[0].quickIntro);
            const [isLoading, setIsLoading] = useState(false);
            const [speaking, setSpeaking] = useState({ zh: false, en: false });
            const [showDetailed, setShowDetailed] = useState(false);
            const [messages, setMessages] = useState([]);
            const [userInput, setUserInput] = useState("");
            const [chatHistory, setChatHistory] = useState([]);
            const chatEndRef = useRef(null);
            const synth = window.speechSynthesis;

            useEffect(() => {
                const saved = localStorage.getItem('chat_history');
                if (saved) setChatHistory(JSON.parse(saved));
            }, []);

            useEffect(() => {
                setContent(currentEra.quickIntro);
                setShowDetailed(false);
            }, [currentEra]);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const speak = (text, lang) => {
                synth.cancel();
                if (speaking[lang]) { setSpeaking({ zh: false, en: false }); return; }
                const ut = new SpeechSynthesisUtterance(text);
                ut.lang = lang === 'zh' ? 'zh-CN' : 'en-US';
                ut.onstart = () => setSpeaking({ ...speaking, [lang]: true });
                ut.onend = () => setSpeaking({ zh: false, en: false });
                synth.speak(ut);
            };

            const handleChat = async (e) => {
                e.preventDefault();
                if (!userInput.trim()) return;
                const newMsg = { role: 'user', content: userInput };
                const updatedMessages = [...messages, newMsg];
                setMessages(updatedMessages);
                setUserInput("");

                try {
                    const res = await fetch('/.netlify/functions/deepseek-proxy', {
                        method: 'POST',
                        body: JSON.stringify({ era: `${currentEra.name} (${userInput})` })
                    });
                    const data = await res.json();
                    const aiMsg = { role: 'ai', content: data.choices[0].message.content };
                    const finalChat = [...updatedMessages, aiMsg];
                    setMessages(finalChat);
                    
                    const newHistory = [{ id: Date.now(), title: userInput.slice(0, 15), dialog: finalChat }, ...chatHistory];
                    setChatHistory(newHistory.slice(0, 10)); // 仅保留最近10条
                    localStorage.setItem('chat_history', JSON.stringify(newHistory.slice(0, 10)));
                } catch (err) {
                    setMessages([...updatedMessages, { role: 'ai', content: "抱歉，历史专家暂时无法连线。" }]);
                }
            };

            const deleteHistory = (id) => {
                const updated = chatHistory.filter(h => h.id !== id);
                setChatHistory(updated);
                localStorage.setItem('chat_history', JSON.stringify(updated));
            };

            return (
                <div className="flex min-h-screen">
                    <aside className="w-72 bg-slate-900 text-white fixed h-full p-6 z-20 overflow-y-auto flex flex-col">
                        <div className="mb-8">
                            <h2 className="text-2xl font-bold text-blue-400 serif italic">Chronos</h2>
                            <p className="text-[10px] text-slate-400 mt-1 uppercase leading-tight tracking-wider font-semibold">龚凤乾教授设计的助学App<br/>《英国历史探索》</p>
                        </div>
                        <nav className="space-y-1 flex-1">
                            {ERAS.map(era => (
                                <button key={era.id} onClick={() => setCurrentEra(era)} className={`w-full text-left p-3 rounded-lg transition ${currentEra.id === era.id ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}>
                                    <div className="text-sm font-bold">{era.enName}</div>
                                    <div className="text-[11px] opacity-60">{era.name}</div>
                                </button>
                            ))}
                        </nav>
                        <div className="mt-8 pt-6 border-t border-slate-800">
                            <p className="text-[10px] text-slate-500 font-bold mb-3 uppercase tracking-widest">对话历史</p>
                            <div className="space-y-2">
                                {chatHistory.map(item => (
                                    <div key={item.id} className="history-item flex justify-between items-center group bg-slate-800/40 p-2 rounded cursor-pointer hover:bg-slate-800 transition">
                                        <span className="text-xs truncate flex-1" onClick={() => setMessages(item.dialog)}>{item.title}...</span>
                                        <button onClick={() => deleteHistory(item.id)} className="delete-btn opacity-0 text-slate-500 hover:text-red-400 ml-2"><i className="fas fa-trash-alt text-[10px]"></i></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </aside>

                    <main className="ml-72 flex-1 p-10 bg-white min-h-screen">
                        <header className="mb-10 flex justify-between items-end border-b pb-8">
                            <div>
                                <h1 className="text-5xl font-black serif text-slate-900 mb-2">{currentEra.enName}</h1>
                                <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-bold">{currentEra.year}</span>
                            </div>
                        </header>

                        <div className="bilingual-grid mb-12">
                            <div className="p-8 bg-slate-50 rounded-2xl relative border border-slate-100">
                                <button onClick={() => speak(content.zh, 'zh')} className={`play-btn absolute top-6 right-6 ${speaking.zh ? 'playing' : ''}`}><i className="fas fa-volume-up"></i></button>
                                <p className="text-lg leading-relaxed text-slate-800">{content.zh}</p>
                            </div>
                            <div className="p-8 bg-blue-50/50 rounded-2xl relative border border-blue-100">
                                <button onClick={() => speak(content.en, 'en')} className={`play-btn absolute top-6 right-6 ${speaking.en ? 'playing' : ''}`}><i className="fas fa-volume-up"></i></button>
                                <p className="text-xl leading-relaxed serif italic text-slate-700">{content.en}</p>
                            </div>
                        </div>

                        <section className="mt-12 bg-slate-100 rounded-2xl p-6 border border-slate-200">
                            <h3 className="text-xl font-bold text-slate-800 serif mb-6 flex items-center gap-3">
                                <span className="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm italic">G</span>向专家提问
                            </h3>
                            <div className="chat-scroll mb-6 space-y-4">
                                {messages.map((msg, i) => (
                                    <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[80%] p-4 rounded-2xl ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-slate-800 shadow-sm border border-slate-200 rounded-tl-none'}`}>
                                            <p className="text-sm">{msg.content}</p>
                                        </div>
                                    </div>
                                ))}
                                <div ref={chatEndRef} />
                            </div>
                            <form onSubmit={handleChat} className="flex gap-2">
                                <input type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)} placeholder="请输入您想问的问题..." className="flex-1 px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <button type="submit" className="bg-slate-900 text-white px-6 py-3 rounded-xl hover:bg-slate-800 transition"><i className="fas fa-paper-plane"></i></button>
                            </form>
                        </section>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>