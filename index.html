<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos: 英国历史探索 - 龚凤乾教授设计</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;700&family=Inter:wght@400;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .serif { font-family: 'Crimson Pro', serif; }
        .bilingual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        @media (max-width: 768px) { .bilingual-grid { grid-template-columns: 1fr; } }
        .play-btn { transition: all 0.3s; cursor: pointer; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .play-btn.active { background: #22c55e !important; color: white !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .chat-container { height: 250px; overflow-y: auto; scrollbar-width: thin; border-radius: 12px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ERAS = [
            { id: 'pre-roman', name: '史前与凯尔特', enName: 'Pre-Roman & Celtic', year: 'Before AD 43', quickIntro: { zh: "史前时期的英国是不列颠文明的曙光，以巨石阵和凯尔特部落文明闻名。", en: "Pre-Roman Britain marks the dawn of civilization, famous for Stonehenge and Celtic tribes." } },
            { id: 'roman', name: '罗马统治时期', enName: 'Roman Britain', year: 'AD 43 - 410', quickIntro: { zh: "罗马人带来了城市、道路和法律。哈德良长城是这一时期的重要遗迹。", en: "Romans introduced cities, roads, and laws." } },
            { id: 'anglo-saxon', name: '盎格鲁-撒克逊', enName: 'Anglo-Saxon Era', year: '410 - 1066', quickIntro: { zh: "罗马撤军后，日耳曼部落定居于此，形成了早期英格兰王国的雏形。", en: "Germanic tribes settled, forming early England." } },
            { id: 'medieval', name: '中世纪盛期', enName: 'The Middle Ages', year: '1066 - 1485', quickIntro: { zh: "骑士、领主和大宪章的时代。", en: "An age of knights and Magna Carta." } },
            { id: 'tudor', name: '都铎王朝', enName: 'The Tudors', year: '1485 - 1603', quickIntro: { zh: "宗教改革和海外扩张的黄金时代。", en: "Golden age of Henry VIII and Elizabeth I." } },
            { id: 'stuart', name: '斯图亚特王朝', enName: 'Stuart Period', year: '1603 - 1714', quickIntro: { zh: "经历了内战与光荣革命。", en: "Through Civil War and Glorious Revolution." } },
            { id: 'georgian', name: '乔治时代', enName: 'Georgian Era', year: '1714 - 1837', quickIntro: { zh: "大英帝国扩张与工业革命萌芽。", en: "Imperial expansion and Industrial Revolution." } },
            { id: 'victorian', name: '维多利亚时代', enName: 'Victorian Era', year: '1837 - 1901', quickIntro: { zh: "日不落帝国与社会变革。", en: "The peak of the British Empire." } },
            { id: 'edwardian', name: '爱德华时代', enName: 'Edwardian Era', year: '1901 - 1910', quickIntro: { zh: "一战前的短暂繁荣与宁静。", en: "Brief elegance before WWI." } },
            { id: 'world-wars', name: '世界大战时期', enName: 'World Wars Era', year: '1914 - 1945', quickIntro: { zh: "两次大战深刻改变了英国地位。", en: "World Wars reshaped Britain." } },
            { id: 'post-war', name: '战后重建', enName: 'Post-War Period', year: '1945 - 1979', quickIntro: { zh: "福利国家建立与去殖民化。", en: "Birth of the welfare state." } },
            { id: 'thatcher', name: '撒切尔时代', enName: 'Thatcher Era', year: '1979 - 1990', quickIntro: { zh: "激进的经济改革。", en: "Radical economic reforms." } },
            { id: 'modern', name: '现代英国', enName: 'Modern Britain', year: '1990 - Present', quickIntro: { zh: "数字化背景下的新身份。", en: "Navigating globalization." } }
        ];

        const App = () => {
            const [currentEra, setCurrentEra] = useState(ERAS[0]);
            const [messages, setMessages] = useState([]);
            const [userInput, setUserInput] = useState("");
            const [isTyping, setIsTyping] = useState(false);
            const [speaking, setSpeaking] = useState({ zh: false, en: false });
            const chatEndRef = useRef(null);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const speak = (text, lang) => {
                const synth = window.speechSynthesis;
                synth.cancel();
                if (speaking[lang]) {
                    setSpeaking({ zh: false, en: false });
                    return;
                }
                const ut = new SpeechSynthesisUtterance(text);
                ut.lang = lang === 'zh' ? 'zh-CN' : 'en-US';
                ut.onstart = () => setSpeaking({ zh: lang === 'zh', en: lang === 'en' });
                ut.onend = () => setSpeaking({ zh: false, en: false });
                synth.speak(ut);
            };

            const handleSend = async (e) => {
                if (e) e.preventDefault();
                if (!userInput.trim()) return;

                const userMsg = { role: 'user', content: userInput };
                setMessages(prev => [...prev, userMsg]);
                setUserInput("");
                setIsTyping(true);

                try {
                    const response = await fetch('/.netlify/functions/deepseek-proxy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ era: `${currentEra.name}: ${userInput}` })
                    });
                    
                    const data = await response.json();
                    const aiContent = data.choices[0].message.content;
                    setMessages(prev => [...prev, { role: 'ai', content: aiContent }]);
                } catch (err) {
                    setMessages(prev => [...prev, { role: 'ai', content: "专家暂时无法连线，请确保 API Key 已在 Netlify 后台配置。" }]);
                } finally {
                    setIsTyping(false);
                }
            };

            return (
                <div className="flex min-h-screen">
                    <aside className="w-72 bg-slate-900 text-white fixed h-full p-6 overflow-y-auto">
                        <h2 className="text-2xl font-bold text-blue-400 serif italic mb-8">Chronos</h2>
                        <nav className="space-y-1">
                            {ERAS.map(era => (
                                <button key={era.id} onClick={() => setCurrentEra(era)} className={`w-full text-left p-3 rounded-lg transition ${currentEra.id === era.id ? 'bg-blue-600' : 'text-slate-400 hover:bg-slate-800'}`}>
                                    <div className="text-sm font-bold">{era.enName}</div>
                                    <div className="text-[11px] opacity-60">{era.name}</div>
                                </button>
                            ))}
                        </nav>
                    </aside>

                    <main className="ml-72 flex-1 p-10 bg-white min-h-screen flex flex-col">
                        <header className="mb-10 border-b pb-8">
                            <h1 className="text-5xl font-black serif text-slate-900 mb-2">{currentEra.enName}</h1>
                            <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-bold">{currentEra.year}</span>
                        </header>

                        <div className="bilingual-grid mb-10">
                            <div className="p-8 bg-slate-50 rounded-2xl relative border">
                                <button onClick={() => speak(currentEra.quickIntro.zh, 'zh')} className={`play-btn absolute top-4 right-4 ${speaking.zh ? 'active' : ''}`}><i className="fas fa-volume-up"></i></button>
                                <p className="text-lg text-slate-800">{currentEra.quickIntro.zh}</p>
                            </div>
                            <div className="p-8 bg-blue-50/50 rounded-2xl relative border">
                                <button onClick={() => speak(currentEra.quickIntro.en, 'en')} className={`play-btn absolute top-4 right-4 ${speaking.en ? 'active' : ''}`}><i className="fas fa-volume-up"></i></button>
                                <p className="text-xl serif italic text-slate-700">{currentEra.quickIntro.en}</p>
                            </div>
                        </div>

                        <section className="mt-auto bg-slate-100 p-6 rounded-2xl border">
                            <h3 className="font-bold mb-4 text-slate-700 flex items-center gap-2"><i className="fas fa-robot text-blue-600"></i> 向历史专家提问</h3>
                            <div className="chat-container bg-white p-4 mb-4 border">
                                {messages.map((m, i) => (
                                    <div key={i} className={`mb-3 flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`p-3 rounded-lg max-w-[85%] text-sm ${m.role === 'user' ? 'bg-blue-600 text-white' : 'bg-slate-200'}`}>{m.content}</div>
                                    </div>
                                ))}
                                {isTyping && <div className="text-xs text-slate-400 animate-pulse">正在查阅卷宗...</div>}
                                <div ref={chatEndRef} />
                            </div>
                            <form onSubmit={handleSend} className="flex gap-2">
                                <input type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)} className="flex-1 p-3 rounded-lg border outline-none focus:ring-2 focus:ring-blue-400" placeholder="在此输入问题..." />
                                <button type="submit" className="bg-slate-900 text-white px-6 py-3 rounded-lg hover:bg-slate-800 transition"><i className="fas fa-paper-plane"></i></button>
                            </form>
                        </section>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>